# 科研日志

## 2026.1.17~1.18

### 基础情况分析

#### 最基础的物理情况分析与PSF构建

<img src="C:\Users\HUAWEI\Desktop\科研记事本\绘图\二维视图.png" alt="二维视图" style="zoom:70%;" />

**基础前提条件与物理情景：**

1. 假设失焦情况是空间不变的，==整个摄影平面内的离焦程度相同==；
2. 忽略衍射条纹和像差导致的强度起伏，假设==光强在弥散圆内均匀分布，不考虑像差项带来的强度分配问题==；

**数学表达式推导**

在最基础的近似下，我们采用几何光学模型。

设光学系统的焦距为 $f$，光圈直径为 $D$（对应F数为 $N = f/D$）。当物体位于物距 $S_o$ 处时，根据高斯成像公式 $\frac{1}{f} = \frac{1}{S_o} + \frac{1}{S_i}$，其理想像距为 $S_i$。

然而在实际拍摄中，CCD传感器可能并未精确置于 $S_i$ 处，而是位于距离透镜 $S_{ccd}$ 的位置，这种位置失配 $\Delta z = |S_i - S_{ccd}|$ 导致光锥截面在传感器上形成一个半径为 $R$ 的圆形光斑。

根据相似三角形关系，我们可以推导出**弥散圆直径 $c = 2R$​ 的解析式**：
$$
c = \frac{D \cdot |S_i - S_{ccd}|}{S_i} = \frac{f^2}{N} \frac{|S_o - S_{focus}|}{S_o (S_{focus} - f)}
$$
其中 $S_{focus}$ 是当前镜头对焦的物距。**该公式说明任何落在该圆内的像素，都将受到来自该物点光信号的“污染”。**

对于“最简单的圆形点扩散函数”模型，==假设光强在弥散圆内是均匀分布的，忽略衍射条纹和像差导致的强度起伏==，这被称为**盒状点扩散函数**，其数学表达为：
$$
PSF_{geom}(x, y) = \begin{cases} \frac{1}{\pi R^2}, & \text{if } x^2 + y^2 \le R^2 \\ 0, & \text{otherwise} \end{cases}
$$
为了准确描述像素A与像素B之间的串扰，需要将连续的PSF投影到离散的像素网格上。

**设CCD由正方形像素组成，像素间距为 $p$，填充因子为 $\eta$。**

对于位于坐标 $(u, v)$ 的物点，其在CCD平面产生的理想几何落点为 $(x_c, y_c)$。由于失焦，该点能量扩散为 $PSF(x-x_c, y-y_c)$。现在考虑两个特定的像素：

- **源像素 $j$**：对应物空间位置的理想成像点，中心坐标为 $(x_j, y_j)$。
- **受害像素  $i$**：接收到了不属于它的光信息，中心坐标为 $(x_i, y_i)$，有效感光区域为 $\Omega_i$。

像素 $i$ 接收到的来自对应于像素 $j$ 的物点的光能量，定义为 $C_{j \to i}$，这是PSF在像素 $i$​ 感光面积上的二重积分：
$$
C_{j \to i} = \iint_{\Omega_i} PSF(x - x_j, y - y_j) \, dx \, dy
$$
对于几何模型，这个积分本质上是计算**圆（PSF光斑）与矩形（像素孔径）的重叠面积**。
$$
C_{j \to i} = \frac{1}{\pi R^2} \times \text{Area}\left( \text{Circle}(R, x_j, y_j) \cap \text{Rect}(p, x_i, y_i) \right)
$$

#### 与NewBP的结合及神经网络中的物理失焦层计算全流程

我们定义该层为 **`PhysicalDefocusLayer`**。

- **输入**：理想的清晰图像张量 $\mathbf{X}$ (Batch, Channel, Height, Width)。
- **参数**：PSF 半径 $R$。
- **输出**：CCD 上接收到的模糊图像张量 $\mathbf{Y}$。

##### 前向传播 

**Step 1.1: 构建离散化 PSF 核**

构建一个卷积核 $\mathbf{K}$，设核边长大小为 $2k+1$ 且**确保覆盖光斑直径 $c$**。

==核中任意一点 $(u, v)$ 的权重 $K[u, v]$ 等于日志中的 $C_{j \to i}$==​：
$$
K[u, v] = \frac{\text{Area}(\text{Circle}(R) \cap \text{Pixel}(u, v))}{\pi R^2}
$$
由于模型假设光强均匀，这个 $\mathbf{K}$ 是一个中心对称的、数值仅由 $R$ 决定的矩阵，且满足能量守恒：
$$
\sum_{u,v} K[u, v] = 1
$$
**Step 1.2: 线性变换**

像素点 $(i, j)$ 处的输出 $Y_{i,j}$ 是输入图像 $\mathbf{X}$ 对应邻域与核 $\mathbf{K}$​ 的卷积：
$$
Y_{i,j} = (\mathbf{X} * \mathbf{K})_{i,j} = \sum_{m=-k}^{k} \sum_{n=-k}^{k} X_{i-m, j-n} \cdot K[m, n]
$$

##### 损失计算

观测到的真实模糊图像为 $\mathbf{Y}_{target}$​，定义损失函数为 MSE：
$$
L = \frac{1}{2} \|\mathbf{Y} - \mathbf{Y}_{target}\|_F^2 = \frac{1}{2} \sum_{i,j} (Y_{i,j} - Y_{target, i,j})^2
$$

##### 反向传播

计算损失 $L$ 对输入清晰图像 $\mathbf{X}$ 的梯度 $\frac{\partial L}{\partial \mathbf{X}}$。

**Step 3.1: 计算输出层的梯度误差**

首先计算 Loss 对输出 $\mathbf{Y}$ 的导数，记为 $\delta_{\mathbf{Y}}$​：
$$
\delta_{\mathbf{Y}} = \frac{\partial L}{\partial \mathbf{Y}} = \mathbf{Y} - \mathbf{Y}_{target}
$$
这代表了CCD上每个像素点的“残差”。

**Step 3.2: 梯度回传**

根据链式法则：
$$
\frac{\partial L}{\partial \mathbf{X}} = \frac{\partial L}{\partial \mathbf{Y}} \cdot \frac{\partial \mathbf{Y}}{\partial \mathbf{X}}
$$
其中，==$\frac{\partial \mathbf{Y}}{\partial \mathbf{X}} = \mathbf{H}$（串扰矩阵，是整个成像系统的线性变换矩阵，描述了输入图像向量 $\mathbf{x}$ 经过系统后，如何映射为输出图像向量 $\mathbf{y}$，与后文描述的雅可比矩阵等价）==，所以梯度是 $\mathbf{H}^T \cdot \delta_{\mathbf{Y}}$。

在卷积运算中，**矩阵转置 $\mathbf{H}^T$ 对应于与翻转后的核进行卷积**，令 $\mathbf{K}'$ 为翻转后的核，$\mathbf{K}'[u, v] = \mathbf{K}[-u, -v]$。

输入层的梯度 $\delta_{\mathbf{X}}$​ 计算公式为：
$$
\delta_{\mathbf{X}} = \delta_{\mathbf{Y}} * \mathbf{K}'
$$
**Step 3.3: 结合模型的特殊简化**

由于你采用的是圆形PSF，它是中心对称的，这意味着：
$$
\mathbf{K}_{flipped} = \mathbf{K}
$$
**结论：** 在这个最基础的物理模型下，反向传播的计算过程与前向传播在数学形式上是**完全一致**的——**如果像素 A 的光漏到了像素 B（前向），那么像素 B 上的误差信号，也必须按同样的比例“漏回”给像素 A（反向）**
$$
\text{Backward}(\text{Grad}) \iff \text{Grad} * \mathbf{K}
$$

##### NewBP 视角下的具体梯度解析

对于输入图像上的特定像素 $X_{i,j}$，其梯度 $\nabla X_{i,j}$ 来源如下：

1. **直接梯度**：来自像素自身对应位置的误差回传。
   $$
   G_{direct} = \delta_{Y, i,j} \times K[0, 0]
   $$
   **物理含义**：CCD上 $(i,j)$ 位置的残差中，属于 $X_{i,j}$ 自己贡献的那部分。

2. **间接梯度**：来自周围像素 $(p, q)$ 的误差回传。因为 $X_{i,j}$ 既然“污染”了邻居，邻居的误差也应该由它负责。
   $$
   G_{indirect} = \sum_{(m,n) \neq (0,0)} \delta_{Y, i+m, j+n} \times K[-m, -n]
   $$
   **物理含义**：周围一圈邻居的残差，按照距离权重的加权和。

3. **总梯度**：
   $$
   \frac{\partial L}{\partial X_{i,j}} = G_{direct} + G_{indirect}
   $$

##### 全流程算法伪代码

```python
# 1. 参数准备 (根据日志物理公式)
# 计算弥散圆直径 c，进而确定 PSF 半径 R 和核大小 kernel_size
c = (f**2 / N) * abs(S_o - S_focus) / (S_o * (S_focus - f))
R_pixels = (c / 2) / pixel_pitch
kernel = build_pillbox_kernel(R_pixels) # 构建离散化 PSF

# 2. 前向传播 (Forward)
# 模拟物理失焦：清晰图像 -> 模糊图像
# Y = Hx
blur_img = conv2d(sharp_img, kernel) 

# 3. 计算损失 (Loss)
# 比较物理模拟出的模糊图与实际观测到的模糊图
residue = blur_img - observed_blur_img
loss = 0.5 * sum(residue**2)

# 4. 反向传播 (Backward - NewBP)
# 物理梯度的回流：误差 -> 清晰图像的梯度
# dL/dx = H^T * (dL/dy)
# 由于 Pillbox 是对称的，转置核 = 原核
grad_input = conv2d(residue, kernel) 

# 此时，grad_input 包含了所有基于物理串扰计算出的正确梯度方向，
# 可以传递给前面的神经网络层进行权重更新。
```

#### 雅可比矩阵的构建与计算

##### **构建与推导过程**

对上式求关于 $x_k$ 的偏导数：
$$
\frac{\partial y_i}{\partial x_k} = \frac{\partial}{\partial x_k} \left( \sum_{j} C_{j \to i} x_j \right)
$$
由于这是一个线性系统，只有当 $j=k$​ 时导数不为零，其余项为常数。因此：
$$
\frac{\partial y_i}{\partial x_k} = C_{k \to i}
$$
这意味着，**雅可比矩阵的第 $(i, k)$ 个元素，正是物理上的串扰系数 $C_{k \to i}$**。==设总像素点个数为N==：
$$
\mathbf{J} = \begin{bmatrix} C_{1 \to 1} & C_{2 \to 1} & \cdots & C_{N \to 1} \\ C_{1 \to 2} & C_{2 \to 2} & \cdots & C_{N \to 2} \\ \vdots & \vdots & \ddots & \vdots \\ C_{1 \to N} & C_{2 \to N} & \cdots & C_{N \to N} \end{bmatrix}
$$
其中，串扰矩阵 $\mathbf{H}$ 的每一个元素 $H_{ij}$（即从源像素 $j$ 到受害像素 $i$ 的串扰系数 $C_{j \to i}$）的值，本质上是从核 $\mathbf{K}$ 中“取样”得到的，他们存在以下的数学联系：
$$
H_{ij} = K[u, v]
$$
对于输入图像 $\mathbf{X}$，输出图像 $\mathbf{Y}$​ 的生成过程可以统一写作：
$$
\mathbf{y} = \mathbf{H}\mathbf{x} \iff \mathbf{Y} = \mathbf{X} * \mathbf{K}
$$

##### 雅可比矩阵的具体形式与特性

**稀疏带状矩阵**

由于 PSF 的半径是有限的 $R$，一个物点 $j$ 只能影响它周围半径 $R$ 内的像素。

- 如果像素 $i$ 和 $j$ 的几何距离 $> R$，则 $C_{j \to i} = 0$。
- **结论**：$\mathbf{J}$ 中绝大多数元素都是 0，非零元素集中在主对角线附近的“带状区域”内。

**托普利兹块/托普利兹结构**

假设了空间不变性，**全图离焦程度相同**，无论物点 $j$ 移到哪里，其 PSF 的形状都不变。

这意味着：$C_{j \to i}$ 的值只取决于 $i$ 和 $j$ 的相对位置（即 $i-j$）。

- 数学上，满足 $A_{i,j} = a_{i-j}$ 的矩阵称为托普利兹矩阵。
- 对于二维图像卷积，拉直后的变换矩阵 $\mathbf{J}$ 是一个**双重托普利兹矩阵**。

**对称性 **

- PSF 是圆形且均匀的。
- 这意味着：点 $A$ 对点 $B$ 的干扰 $C_{A \to B}$，完全等于点 $B$ 对点 $A$ 的干扰 $C_{B \to A}$（几何重叠面积不变）。
- **结论**：$\mathbf{J}$ 是一个**对称矩阵**，即 $\mathbf{J}^T = \mathbf{J}$。

------

##### 在神经网络反向传播中的构建与计算

在 NewBP 算法中，我们需要计算 Loss 对输入 $\mathbf{x}$​ 的梯度。根据链式法则：
$$
\nabla_{\mathbf{x}} L = \left( \frac{\partial \mathbf{y}}{\partial \mathbf{x}} \right)^T \nabla_{\mathbf{y}} L = \mathbf{J}^T \cdot \delta_{\mathbf{y}}
$$
**构建方法：隐式卷积法**

根据卷积定理：矩阵向量乘法 $\mathbf{J}^T \mathbf{v}$ 等价于卷积操作
$$
\mathbf{v} * \text{flip}(K)
$$
反向传播的具体形式：
$$
\frac{\partial L}{\partial \mathbf{x}} = \text{Conv2d}(\text{input}=\frac{\partial L}{\partial \mathbf{y}}, \text{weight}=\mathbf{K})
$$

---

### 结合特定像差（初级球差）的初步探索

#### 考虑球差的物理建模与数学推导

##### 物理原理：波前像差函数

在波动光学中，**PSF 是光瞳函数的傅里叶变换的模平方**。球差不仅改变光斑大小，更改变相位的分布。

我们定义归一化光瞳半径 $\rho=\frac{r}{a}$(a为光学系统孔阑大小) ($0 \le \rho \le 1$)，波前像差函数 $W(\rho)$ 描述了实际波前与理想球面波前的偏差。

对于**初级球差**伴随**离焦**的系统，其波前误差由两部分组成：
$$
W(\rho) = \underbrace{C_{defocus} \cdot \rho^2}_{\text{离焦项 (Defocus)}} + \underbrace{C_{SA} \cdot \rho^4}_{\text{球差项 (Spherical Aberration)}}
$$

- **$C_{defocus}$**：由物体深度决定的离焦系数（变量）。
- **$C_{SA}$**：由透镜性质决定的球差系数（常数/超参数）。

##### PSF 的严谨数学表达式

根据标量衍射理论，==对于旋转对称的光学系统，球差和离焦都是旋转对称的==，其点扩散函数 $PSF(r)$ 是光瞳函数的**零阶汉克尔变换**的模平方。

结合你上传的公式图片，完整的、可计算的 **球差 PSF 径向分布公式** 为：
$$
PSF(r) = \left| \int_{0}^{1} P(\rho) \cdot e^{i \cdot k \cdot (C_{defocus} \rho^2 + C_{SA} \rho^4)} \cdot J_0(k \cdot \text{NA} \cdot r \cdot \rho) \cdot \rho \, d\rho \right|^2
$$
**参数详解与物理意义：**

- **$r$**: 成像面上的物理半径距离（单位：米或微米）。
- **$P(\rho)$**: 光瞳振幅函数。通常假设通过透镜的光强均匀，设 $P(\rho)=1$ (当 $\rho \le 1$)，否则为 0。
- **$k$**: 波数，$k = 2\pi / \lambda$。这引入了**波长**的影响，意味着衍射效应被考虑在内。
- **$C_{defocus}$ & $C_{SA}$**: 像差系数，单位通常为光程差。
- **$J_0(\cdot)$**: 第一类零阶贝塞尔函数，是圆形孔径衍射的特征函数。
- **NA**: 数值孔径，$\text{NA} \approx 1 / (2 \cdot F_{\text{number}})$。

##### 构建串扰矩阵 $\mathbf{H}$ (卷积核 $\mathbf{K}$)

为了进入 NewBP 计算，必须将连续的 $PSF(r)$ 离散化为卷积核 $\mathbf{K}$。

设像素间距为 $p$，卷积核大小为 $(2k+1) \times (2k+1)$，中心为 $(0,0)$。对于核中坐标 $(u, v)$：

1. **计算物理距离**：$r_{uv} = p \cdot \sqrt{u^2 + v^2}$

2. **采样光强**：$I_{raw}(u, v) = PSF(r_{uv})$

3. **卷积核大小**：$R_{geom} = \frac{1}{2} \cdot \frac{f^2}{N} \frac{|S_o - S_{focus}|}{S_o (S_{focus} - f)} \div p$ 且 $k \approx \lceil \beta \cdot R_{geom} \rceil$ 其中 $\beta$ 约为1.2~1.5即可。

4. **能量归一化**：
   $$
   K[u, v] = \frac{I_{raw}(u, v)}{\sum_{m,n} I_{raw}(m, n)}
   $$

**特性分析**：

- **形态**：不再是平顶的“盒状”。当 $C_{SA} \neq 0$ 时，==光斑中心可能出现尖峰，周围出现一圈或多圈光环。==

<img src="C:\Users\HUAWEI\AppData\Roaming\Typora\typora-user-images\image-20260119000626246.png" alt="image-20260119000626246" style="zoom:30%;" />

- **对称性**：尽管引入了球差，系统依然保持**旋转对称性**。因此，$\mathbf{K}[u, v] = \mathbf{K}[-u, -v]$ 依然成立。

##### 雅可比矩阵 $\mathbf{J}$ 的形式

在 NewBP 中，雅可比矩阵 $\mathbf{J}$ 依然等同于串扰矩阵 $\mathbf{H}$。

尽管 $PSF$ 的形状变得复杂，但只要它具有旋转对称性，雅可比矩阵 $\mathbf{J}$ 依然是一个对称矩阵 ($\mathbf{J}^T = \mathbf{J}$​)。
$$
J_{ij} = C_{j \to i} \approx K[u_i-u_j, v_i-v_j]
$$
这意味着：**反向传播依然可以用“核翻转卷积”来计算，且核翻转后等于其自身。** 

这一点保证了**算法在引入复杂物理量后，计算复杂度不会爆炸。**

------

#### 参数列表

| **参数类型** | **符号**      | **物理含义**   | **推荐取值范围/来源**                                        |
| ------------ | ------------- | -------------- | ------------------------------------------------------------ |
| **基础常数** | $\lambda$     | 光波长 (Green) | $550 \text{ nm}$ ($0.55 \mu m$)                              |
|              | $p$           | CCD像素尺寸    | $1.0 \sim 4.0 \mu m$                                         |
|              | $\text{NA}$   | 数值孔径       | $0.2 \sim 0.5$ (对应光圈 F2.5~F1.0)                          |
| **超参数**   | $C_{SA}$      | **球差系数**   | **$0$**: 理想模型 **$0.25\lambda \sim 1.0\lambda$**:常见镜头 **$>2.0\lambda$**: 严重像差/软焦效果 |
| **可变参数** | $d_{object}$  | 物体深度       | 来自数据集 Depth Map                                         |
|              | $d_{focus}$   | 对焦距离       | **设定值 (如 1.5m)**                                         |
|              | $C_{defocus}$ | **离焦系数**   | 计算公式：$k \cdot (\frac{1}{d_{object}} - \frac{1}{d_{focus}})$ |
| **计算参数** | $N_{grid}$    | 积分采样点数   | $50 \sim 100$ (用于计算 $\int PSF$)                          |

#### 数据集推荐

数据集必须包含 **RGB 原图** 和 **高精度 Depth Map**。

1. **SYNDOF (Synthetic Depth of Field)**
   - **理由**：这是专门为去模糊和景深模拟设计的合成数据集。它没有真实的像差，背景极其干净，非常适合用来**验证手动添加的球差模型**。如果用真实拍摄的数据，里面已经自带了未知的像差，会干扰实验。
2. **NYU Depth V2**
   - **理由**：经典的室内场景 RGB-D 数据。深度图密集，场景丰富。适合做泛化性测试。
3. **Middlebury Stereo Datasets**
   - **理由**：提供极高精度的视差图（可转为深度），适合精细分析 PSF 在物体边缘的表现。

------

#### 算法层面的计算流程

##### 核心思想

虽然每个像素的 $C_{defocus}$ 都不同，但我们可以根据深度图将其==**量化为 $L$ 个离散层**。==

对于每一层，球差系数 $C_{SA}$ 是固定的，离焦系数 $C_{defocus}$ 也是固定的。

##### 前向传播

**目标**：模拟 $\mathbf{Y} = \mathbf{H}_{SA} \mathbf{X}$

1. **深度离散化**：将输入深度图 $D$ 量化为 $L$ 个等级索引 $Mask_l$。

2. **PSF 核预生成**：

   - 对于每个深度层 $l \in [0, L-1]$：
   - 计算该层的 $C_{defocus}^{(l)}$。
   - 结合固定的 $C_{SA}$，利用**汉克尔变换公式**数值积分生成卷积核 $\mathbf{K}_{SA}^{(l)}$。
   - *(注：这个核现在是==中心亮、边缘有衍射环==的复杂矩阵)*。

3. **分层卷积与融合**：

   - 对原图 $\mathbf{X}$ 分别用 $\mathbf{K}_{SA}^{(l)}$ 进行全图卷积，得到 $L$ 张中间图。

   - 利用 $Mask_l$​ 进行加权求和：
     $$
     \mathbf{Y} = \sum_{l=0}^{L-1} (\mathbf{X} * \mathbf{K}_{SA}^{(l)}) \odot Mask_l
     $$

#### 2. 反向传播 (Backward Pass - NewBP)

**目标**：计算 $\delta_{\mathbf{X}} = \mathbf{J}^T \delta_{\mathbf{Y}}$

在球差模型下，光强不再均匀。如果像素 $j$ 是一个“球差光斑”，**能量高度集中在中心，边缘只有少量光晕。**

- **前向**：$X_j$ 的能量大部分给了自己，少部分漏给了邻居。
- **反向**：邻居的 Error 只有很少一部分应该归咎于 $X_j$，大部分 Error 应该由邻居自己承担。
- **算法体现**：$\mathbf{K}_{SA}$ 的权重分布自动处理了这种归责逻辑。

**计算步骤**：

1. **接收梯度**：$\delta_{\mathbf{Y}} = \mathbf{Y} - \mathbf{Y}_{target}$。

2. **分层反卷积**：

   - 由于 $\mathbf{K}_{SA}^{(l)}$ 是中心对称的，转置核等于原核。
   - 使用**与前向传播完全相同的核** $\mathbf{K}_{SA}^{(l)}$ 对梯度图 $\delta_{\mathbf{Y}}$ 进行卷积。

3. **梯度聚合**：根据深度 $Mask_l$​ 聚合梯度：
   $$
   \delta_{\mathbf{X}} = \sum_{l=0}^{L-1} (\delta_{\mathbf{Y}} * \mathbf{K}_{SA}^{(l)}) \odot Mask_l
   $$

## 2026.1.19

### Zernike系数与像差的引入

#### 问题的扩展

1. 在实际情况下，对于物面上不同的点，发出的光经过光学系统后在CCD上形成的光斑（PSF）是不一样的，每一个点都对应着不同的、与空间位置分布强相关的K（即**K是随着空间位置变化而变化的**），具体可以用Zernike多项式进行建模和拟合；
2. 把这样的随空间变化的K（PSF）替换理想情况下恒定不变的K（PSF），得到进阶版的数据流：
   - 我们通过深度神经网络，得到物面上每一点(u, v)对应的zernike系数，**让一个小型的神经网络（输入像素坐标 $(u, v)$，输出该位置对应的 Zernike 系数，**进而确定我们建模仿真的这个实际光学系统的特性，得到物空间每个物点经过光学系统后得到的PSF分布并确定每一点的K；
   - 在此之后，再通过NewBP指导梯度变化与参数更新，对权重W进行更新。

### 进阶数据流

#### 系统架构概览：双支路协同网络

整个系统由两个并行的支路组成，它们在“物理仿真层”汇合。

##### **支路 A：图像复原支路 **

- **输入**：真实的模糊观测图像 $\mathbf{Y}_{real}$。
- **模型**：深度神经网络，参数为 $\mathbf{W}$。
- **输出**：估计的清晰图像 $\hat{\mathbf{X}}$。
- **任务**：学习图像的统计先验，**尝试去除模糊**。

##### **支路 B：物理光学支路 **

- **输入**：图像的空间坐标网格 $(u, v)$。
- **模型**：隐式坐标网络或简单的参数映射层，参数为 $\mathbf{C}(x,y)$（即==**空间变变的 Zernike 系数**==）。
- **核心组件**：**可微衍射模型 **，它将 Zernike 系数转化为物理 PSF。
- **输出**：空间变变的点扩散函数卷积核 $\mathbf{K}(\mathbf{C})$。
- **任务**：通过梯度下降，**让计算机里的“虚拟镜头”无限逼近现实手中的“物理镜头”。**

------

#### 前向传播

在汇合点，我们将两个支路的输出结合，进行一次“前向物理仿真”。

**数学表达**：
$$
\hat{\mathbf{Y}} = \hat{\mathbf{X}} * \mathbf{K}(\mathbf{C})
$$

1. **光瞳生成**：利用支路 B 输出的 Zernike 系数 $\mathbf{C}$，构建波前相位 $\Phi = \sum C_i Z_i$，进而生成广义光瞳函数 $P(\rho, \theta) = A \cdot e^{i\Phi}$。
2. **PSF 生成**：通过傅里叶变换计算 PSF：$\mathbf{K} = |\mathcal{F}(P)|^2$。
3. **重模糊**：用生成的 $\mathbf{K}$ 对支路 A 输出的 $\hat{\mathbf{X}}$ 进行卷积，得到“重模糊估计图” $\hat{\mathbf{Y}}$。

**损失函数 (Loss)**：
$$
\mathcal{L} = \underbrace{||\hat{\mathbf{Y}} - \mathbf{Y}_{real}||^2}_{\text{自洽性 Loss}} + \underbrace{\lambda ||\hat{\mathbf{X}} - \mathbf{X}_{gt}||^2}_{\text{监督 Loss (如有)}}
$$

------

#### NewBP 的作用与雅可比矩阵的构建

在进阶方案中，NewBP 不再是单向的，而是分裂为**两条梯度流**。

我们需要分别计算 Loss 对 $\mathbf{W}$（图像权重）和 $\mathbf{C}$（光学参数）的导数。

##### **雅可比矩阵的构建**

在基础版中，雅可比矩阵 $\mathbf{J}$ 等于固定的串扰矩阵 $\mathbf{H}$；在进阶版中，雅可比矩阵是动态的、参数化的，且针对不同的变量有不同的物理形式。

##### **流向 A：NewBP 指导图像复原**

- **目的**：告诉复原网络，“你恢复的图像在经过物理模糊后，和真实观测不符，请修改 $\mathbf{W}$”。

- **雅可比矩阵形式 ($\mathbf{J}_{img}$​)**：
  $$
  \mathbf{J}_{img} = \frac{\partial \hat{\mathbf{Y}}}{\partial \hat{\mathbf{X}}} = \mathbf{H}(\mathbf{K})
  $$
  这里，雅可比矩阵依然是由当前生成的卷积核 $\mathbf{K}$ 定义的**托普利兹矩阵**。

- **NewBP 计算过程**：
  $$
  \frac{\partial \mathcal{L}}{\partial \mathbf{W}} = \underbrace{\left( \frac{\partial \mathcal{L}}{\partial \hat{\mathbf{Y}}} * \mathbf{K}^T \right)}_{\text{物理梯度回传}} \cdot \frac{\partial \hat{\mathbf{X}}}{\partial \mathbf{W}}
  $$

  - **NewBP 的作用**：利用当前对光学的最佳估计（$\mathbf{K}$），将残差误差 $\delta$ **反卷积**回清晰域。它充当了**“物理约束的正则化器”**，强迫 $\hat{\mathbf{X}}$ 符合光学成像的逆过程。

------

##### **流向 B：NewBP 指导系统辨识**

- **目的**：告诉光学网络，“你生成的 PSF 不对，导致重模糊图像 $\hat{\mathbf{Y}}$ 和真实图像 $\mathbf{Y}_{real}$ 对不上，请修改 Zernike 系数 $\mathbf{C}$”。

- 雅可比矩阵形式 ($\mathbf{J}_{optics}$)：这是一个全新的雅可比矩阵，描述的是**“图像像素变化对光学像差系数的敏感度”**。
  $$
  \mathbf{J}_{optics} = \frac{\partial \hat{\mathbf{Y}}}{\partial \mathbf{C}}
  $$
  这不是一个简单的矩阵，而是一个**链式物理导数**：
  $$
  \frac{\partial \hat{\mathbf{Y}}}{\partial \mathbf{C}} = \underbrace{\frac{\partial (\hat{\mathbf{X}} * \mathbf{K})}{\partial \mathbf{K}}}_{\text{Convolution}} \cdot \underbrace{\frac{\partial \mathbf{K}}{\partial P}}_{\text{Modulus}} \cdot \underbrace{\frac{\partial P}{\partial \Phi}}_{\text{Complex Exp}} \cdot \underbrace{\frac{\partial \Phi}{\partial \mathbf{C}}}_{\text{Zernike Basis}}
  $$

- **NewBP 计算过程**：
  $$
  \frac{\partial \mathcal{L}}{\partial \mathbf{C}} = \frac{\partial \mathcal{L}}{\partial \hat{\mathbf{Y}}} \cdot \mathbf{J}_{optics}
  $$

  - **NewBP 的作用**：这里 NewBP 起到了**“自动微分光学 ”**的作用，能够穿透 FFT和复数运算，计算出：“像散系数 $C_5$ 增加 0.01，会导致最终图像的 Loss 增加还是减少”，从而实现对真实物理参数的**反向求解**。

##### 前向仿真“逐点卷积”的理解

在的进阶版中，成像过程变成了：
$$
Y(u) = \int X(v) \cdot K_v(u - v) \, dv
$$
这里的 $K_v$表示核的形状 $K$ 取决于源点的位置 $v$，这物理上完全等同于：

1. 取出一个源点 $X(v)$。
2. 根据 $v$ 算出它的专属光斑 $K_v$。
3. 把 $X(v)$ 的能量按 $K_v$ 撒到画布 $Y$ 上。
4. **对所有 $v$ 重复此步骤并累加。**

##### 核心数学表达：从 Zernike 到 PSF

1. **波前像差**：在光瞳平面 $(\rho, \theta)$ 上，波前误差 $W$ 是 Zernike 多项式 $Z_j$​ 的线性组合：
   $$
   \Phi(\rho, \theta; \mathbf{C}) = \sum_{j=1}^{M} C_j \cdot Z_j(\rho, \theta)
   $$
   这里 $\mathbf{C}$ 是我们要学习的参数，其中，**$Z_j$——泽尼克多项式**是一组定义在**单位圆（Unit Disk, $\rho \le 1$）**上的正交多项式序列，可以把任何复杂的波前误差分解为一系列简单形状的叠加。

   公式通常表达为**径向（Radial）和角向（Azimuthal）**两部分的乘积，参考取值为：
   $$
   Z_n^m(\rho, \theta) = R_n^m(\rho) \cdot \begin{cases} \cos(m\theta) & m \ge 0 \\ \sin(|m|\theta) & m < 0 \end{cases}
   $$

   | **Noll Index (j)** | **名称 (Aberration)** | **极坐标公式 (Zj)**                    | **物理直观**                  |
   | ------------------ | --------------------- | -------------------------------------- | ----------------------------- |
   | **1**              | Piston (平移)         | $1$                                    | 整体相位移动 (不影响成像质量) |
   | **2**              | Tilt X (倾斜)         | $2\rho \cos\theta$                     | 图像位置平移                  |
   | **3**              | Tilt Y (倾斜)         | $2\rho \sin\theta$                     | 图像位置平移                  |
   | **4**              | **Defocus (离焦)**    | $\sqrt{3}(2\rho^2 - 1)$                | **最核心项**：光斑变大变圆    |
   | **5**              | Astigmatism 1 (像散)  | $\sqrt{6}\rho^2 \sin(2\theta)$         | 光斑变椭圆 (45度方向)         |
   | **6**              | Astigmatism 2 (像散)  | $\sqrt{6}\rho^2 \cos(2\theta)$         | 光斑变椭圆 (水平/垂直)        |
   | **7**              | Coma 1 (彗差)         | $\sqrt{8}(3\rho^3 - 2\rho) \sin\theta$ | 彗星状拖尾 (Y轴)              |
   | **8**              | Coma 2 (彗差)         | $\sqrt{8}(3\rho^3 - 2\rho) \cos\theta$ | 彗星状拖尾 (X轴)              |
   | **11**             | **Spherical (球差)**  | $\sqrt{5}(6\rho^4 - 6\rho^2 + 1)$      | **光晕/柔焦效果**             |

2. **广义光瞳函数**：
   $$
   P(\rho, \theta) = A(\rho, \theta) \cdot e^{i \frac{2\pi}{\lambda} \Phi(\rho, \theta; \mathbf{C})}
   $$
   $A$ 是孔径函数，通常为圆形 mask。

3. **PSF 生成 (傅里叶光学)**：PSF 是光瞳函数的傅里叶变换的模平方：
   $$
   K(\mathbf{C}) = \left| \mathcal{F}\{ P(\rho, \theta) \} \right|^2
   $$
   $\mathcal{F}$ (FFT) 和模平方运算在 PyTorch/TensorFlow 中都是可微的，这意味着 $\frac{\partial K}{\partial \mathbf{C}}$ 是可计算的。

##### 实际计算层面的修正

在**实际算法落地**时，通常采用 **“分块近似”** 或 **“重叠相加法“**：

1. **分块（Patching）**：将图像 $X$ 切割成许多小块（例如 $64 \times 64$），块之间有重叠。
2. **局部等晕近似**：假设在这个小块内，像差变化不大。
3. **代表性卷积**：只计算该块中心点坐标 $(u_c, v_c)$ 对应的 Zernike 系数和 $K_{center}$。
4. **块卷积**：用这个 $K_{center}$ 对该小块进行一次标准卷积。
5. **融合**：将所有卷好的小块拼回去（重叠部分加权平均）。

### 计算开销与对应策略

#### 朴素计算的代价

在理论公式 $\hat{Y}(u) = \sum_v \hat{X}(v) K_v(u-v)$ 中，每个像素 $v$ 都有一个自己专属的卷积核 $K_v$。假设：

- 图像尺寸 $(H, W) = 1024 \times 1024 \approx 10^6$ 像素。
- PSF 卷积核大小 $K_{size} \times K_{size} = 31 \times 31 \approx 1000$ 个参数。
- Batch Size $B = 1$。
- 数据类型为 `float32` (4 bytes)。

为了进行并行的矩阵乘法（现代 GPU 的强项），我们通常需要显式地生成所有核。

- **存储需求**：$10^6 \text{ (pixels)} \times 1000 \text{ (params/pixel)} \times 4 \text{ bytes} \approx 4 \text{ GB}$。
- 在反向传播中，PyTorch 需要保存中间的激活值和雅可比矩阵的梯度图。对于空间变变卷积，自动微分图的显存占用通常是前向传播的 **5~10 倍**。
- **结论**：单张图训练可能直接吃掉 30GB+ 显存，且计算速度极慢，因为无法利用 `cudnn.conv2d` 的底层优化。

------

#### 基于重叠相加（Overlap-Add, OLA）的分块近似策略

**核心假设**：虽然像差在全图是变化的，但在一个较小的区域内（例如 $64 \times 64$ 像素），像差的变化是可以忽略不计的，即认为==该区域内的 PSF 是恒定的。==

##### 算法流程详细阐述

我们不再对每个像素计算 PSF，而是对**每个图像块（Patch）**计算 PSF。

**Step 1: 网格划分**

- 将大图 $\mathbf{X}$ 切分为 $M \times N$ 个 Patch。
- **关键点**：Patch 之间必须有**重叠**。
  - 如果不，**Patch 边缘的卷积结果会因为缺乏邻域信息而出现截断伪影，拼接后会有明显的方格网格线。**
  - **重叠宽度**：至少为卷积核半径 $R$，建议重叠 25%~50%。

**Step 2: 锚点 PSF 生成**

- 取每个 Patch 的中心坐标 $(u_c, v_c)$。
- 将坐标喂给你的 `AberrationNet`（光学支路），**算出该 Patch 的 Zernike 系数。**
- 生成该 Patch 专属的 **唯一卷积核** $\mathbf{K}_{patch}$。
- 降维效果：如果 Patch 大小是 $128 \times 128$，计算量直接降低了 $10^4$ 倍！

**Step 3: 局部卷积**

- 对第 $i$ 个 Patch $\mathbf{P}_i$，执行标准卷积：
  $$
  \mathbf{O}_i = \mathbf{P}_i * \mathbf{K}_{patch\_i}
  $$

- 这是标准的“空间不变卷积”，可以直接调用 PyTorch 的 `F.conv2d`

**Step 4: 加权融合**

- 将所有卷好的块 $\mathbf{O}_i$ 拼回大图。

- 在重叠区域，不能简单相加，需要使用窗函数进行加权平均，以消除边缘的突变。
  $$
  \hat{\mathbf{Y}} = \frac{\sum_i (\mathbf{O}_i \cdot \mathbf{W}_i)}{\sum_i \mathbf{W}_i}
  $$
  其中 $\mathbf{W}_i$ 是空间权重掩膜。

------

##### 进阶数据流下的 NewBP 适配

采用了 OLA 策略后，NewBP 的反向传播依然是严格成立的，而且变得更加高效。

**前向**：
$$
\text{Loss} = \text{MSE}(\sum (\text{Patch}_i * K_i), Y_{real})
$$
**反向**：梯度流会自动沿着“加权融合”的逆路径回传。

1. **对图像支路 ($\mathbf{W}$) 的梯度**：
   - 全图梯度 $\delta_{global}$ 被切分并分配给每个 Patch。
   - 每个 Patch 接收到的梯度 $\delta_i$，通过其对应的 $\mathbf{K}_i^T$（转置核）进行反卷积。
   - **物理意义**：局部区域的复原，只受局部区域的光学特性的约束。
2. **对光学支路 ($\mathbf{C}$) 的梯度**：
   - Patch $i$ 的残差 $\delta_i$ 与该块的清晰图估计 $\hat{\mathbf{X}}_i$ 进行相关运算，计算出对核 $\mathbf{K}_i$ 的梯度。
   - 进而更新该 Patch 中心的 Zernike 系数。

