# =============================================================================
# 物理驱动盲去卷积网络 - 默认配置文件
# Physics-Driven Blind Deconvolution Network - Default Configuration
# =============================================================================

# -----------------------------------------------------------------------------
# 物理光学参数 (Physics / Optics)
# -----------------------------------------------------------------------------
physics:
  # Zernike 多项式相关
  n_modes: 15                    # Zernike 模式数量 (Noll 1-15)
  pupil_size: 64                 # 光瞳计算网格大小
  kernel_size: 33                # PSF 卷积核大小 (必须为奇数)
  oversample_factor: 2           # FFT 过采样因子
  
  # 波长配置 (单位: 米)
  ref_wavelength: 550.0e-9       # 参考波长 (绿光)
  wavelengths:                   # RGB 波长列表
    - 620.0e-9                   # 红光
    - 550.0e-9                   # 绿光
    - 450.0e-9                   # 蓝光

# -----------------------------------------------------------------------------
# 空间变化卷积层 (OLA - Overlap-Add)
# -----------------------------------------------------------------------------
ola:
  patch_size: 128                # 补丁大小
  stride: 64                     # 补丁步长 (50% 重叠)
  pad_to_power_2: true           # FFT 是否填充到 2 的幂
  use_newbp: true                # 是否启用 NewBP 算法 (非对角雅可比)

# -----------------------------------------------------------------------------
# 像差预测网络 (Aberration Network)
# -----------------------------------------------------------------------------
aberration_net:
  # 通用参数
  n_coeffs: 15                   # 输出 Zernike 系数数量
  a_max: 2.0                     # 系数约束范围 [-a_max, a_max]
  
  # 网络类型: "polynomial" 或 "mlp"
  type: "polynomial"
  
  # PolynomialAberrationNet 专用参数
  polynomial:
    degree: 2                    # 多项式阶数 (2 阶 = 6 项)
  
  # AberrationNet (MLP) 专用参数
  mlp:
    hidden_dim: 64               # 隐层维度
    use_fourier: true            # 是否使用傅里叶特征编码
    fourier_scale: 5             # 傅里叶特征缩放因子
    a_max_mlp: 3.0               # MLP 版本的系数范围 (通常比 polynomial 更大)

# -----------------------------------------------------------------------------
# 图像复原网络 (Restoration Network - U-Net)
# -----------------------------------------------------------------------------
restoration_net:
  n_channels: 3                  # 输入通道数 (RGB)
  n_classes: 3                   # 输出通道数 (RGB)
  base_filters: 64               # 基础滤波器数量
  bilinear: true                 # 上采样方式: true=双线性插值, false=转置卷积
  use_coords: true               # 是否启用坐标注入 (CoordConv)
  
  # U-Net 架构配置 (通道倍数)
  channel_multipliers:
    - 1                          # Inc:   base_filters × 1 = 64
    - 2                          # Down1: base_filters × 2 = 128
    - 4                          # Down2: base_filters × 4 = 256
    - 8                          # Down3: base_filters × 8 = 512
    - 8                          # Down4: base_filters × 8 = 512 (瓶颈)

# -----------------------------------------------------------------------------
# 训练配置 (Training)
# -----------------------------------------------------------------------------
training:
  # 优化器
  optimizer:
    type: "adamw"                # 优化器类型
    lr_restoration: 1.0e-4       # 复原网络学习率
    lr_optics: 1.0e-5            # 像差网络学习率
    weight_decay: 0.01           # 权重衰减
  
  # 损失函数权重
  loss:
    lambda_sup: 1.0              # 监督损失权重 (无 GT 时为 0)
    lambda_coeff: 0.01           # 系数 L2 正则化权重
    lambda_smooth: 0.01          # 空间平滑性正则化权重
  
  # 梯度裁剪
  gradient_clip:
    restoration: 5.0             # 复原网络梯度裁剪阈值
    optics: 1.0                  # 像差网络梯度裁剪阈值
  
  # 正则化采样
  smoothness_grid_size: 16       # TV 损失计算的网格大小

# -----------------------------------------------------------------------------
# 数据配置 (Data)
# -----------------------------------------------------------------------------
data:
  batch_size: 64                  # 批大小
  image_height: 256              # 图像高度
  image_width: 256               # 图像宽度
  num_workers: 8                 # 数据加载线程数
  
  # 数据增强
  augmentation:
    horizontal_flip: true
    vertical_flip: true
    random_crop: true

# -----------------------------------------------------------------------------
# 可视化配置 (Visualization)
# -----------------------------------------------------------------------------
visualization:
  # PSF 网格可视化
  psf_grid:
    rows: 5                      # 采样行数
    cols: 5                      # 采样列数
    coord_range: [-0.9, 0.9]     # 采样坐标范围
    colormap: "inferno"          # 颜色映射
  
  # 系数分布可视化
  coeff_maps:
    grid_size: 128               # 采样密度
    indices: [3, 4, 5, 6]        # 显示的 Zernike 索引 (Noll 4-7)
    colormap: "viridis"          # 颜色映射

# -----------------------------------------------------------------------------
# 实验配置 (Experiment)
# -----------------------------------------------------------------------------
experiment:
  name: "default"                # 实验名称
  seed: 42                       # 随机种子
  device: "cuda"                 # 计算设备: "cuda" 或 "cpu"
  epochs: 100                    # 训练轮数
  save_interval: 5              # 保存间隔 (epochs)
  log_interval: 5                # 日志间隔 (epochs)
  output_dir: "results"          # 输出目录
